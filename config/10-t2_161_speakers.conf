# SPDX-License-Identifier: MIT
# (C) 2023 T2 Linux Team

context.properties = {
    default.clock.rate = 48000
    default.clock.allowed-rates = [ 44100 48000 96000 ]
}

context.modules = [
    { name = libpipewire-module-filter-chain
        args = {
            node.description = "MacBook Pro T2 DSP Speakers"
            media.name       = "MacBook Pro T2 DSP Speakers"
            filter.graph = {
                nodes = [
                    {
                        "type": "lv2",
                        "plugin": "https://chadmed.au/bankstown",
                        "name": "virtualbass",
                        "control": {
                            "bypass": 0,
                            "amt": 2.0,
                            "sat_second": 1.5,
                            "sat_third": 3.0,
                            "blend": 1.0,
                            "ceil": 220.0,
                            "floor": 60.0,
                        }
                    }
                    {
                    type = lv2
                    plugin = "http://lsp-plug.in/plugins/lv2/compressor_stereo"
                    name = compressor
                    control = {
                        # Enable
                        mode = 1
                        enabled = 1
                        # Preamp volumes
                        g_in = 1.0    # Input gain
                        g_out = 0.7   # Output gain
                        g_dry = 0.0   # Dry mix
                        g_wet = 1.0   # Wet mix
                        
                        # Compression Parameters
                        ce = 1        # Compressor enabled
                        al = 0.1258925 # Attack threshold (-18 dB)
                        at = 20.0     # Attack time [ms]: 0.0..2000.0
                        rrl = 0.00001 # Release threshold [G]: 0.0..63.0957489
                        rt = 200.0    # Release time [ms]: 0.0..5000.0
                        cr = 6.0      # Ratio (6:1): 1.0..100.0
                        kn = 0.251197 # Knee (-12 dB): 0.0631..1.0
                        sla = 10.0    # Sidechain level adjust
                        mk = 3      # Makeup gain
                        
                        # Sidechain Parameters (Optional)
                        sc = 0        # Sidechain input (0: off, 1: on)
                        }
                    }
                    {
                         type   = ladspa
                         name   = limiter
                         plugin = fast_lookahead_limiter_1913
                         label  = fastLookaheadLimiter
                         control = { "Input gain (dB)" = 0 "Limit (dB)" = -1 "Release time (s)" = 0.8 }
                    }
                    # Left Tweeter
                    {
                        type = builtin
                        label = convolver
                        name = convLT
                        config = {
                            filename = [/usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_tweeters_5-44k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_tweeters_5-48k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_tweeters_5-96k.wav]
                            channel = 0
                        }
                    }

                    # Right Tweeter
                    {
                        type = builtin
                        label = convolver
                        name = convRT
                        config = {
                            filename = [/usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_tweeters_5-44k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_tweeters_5-48k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_tweeters_5-96k.wav]
                            channel = 0
                        }
                    }

                    # Left Woofer
                    {
                        type = builtin
                        label = convolver
                        name = convLW
                        config = {
                            filename = [/usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_woofers_5-44k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_woofers_5-48k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_woofers_5-96k.wav]
                            channel = 0
                        }
                    }

                    # Right Woofer
                    {
                        type = builtin
                        label = convolver
                        name = convRW
                        config = {
                            filename = [/usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_woofers_5-44k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_woofers_5-48k.wav,
                                        /usr/share/pipewire/devices/apple/macbook_pro_t2_16_1_woofers_5-96k.wav]
                            channel = 0
                        }
                    }

                    { type = builtin label = copy name = LW }
                    { type = builtin label = copy name = LW2 }
                    { type = builtin label = copy name = RW }
                    { type = builtin label = copy name = RW2 }
                ]
                
                 

                # Map the inputs to their appropriate convolvers
                links = [
                    { output = "virtualbass:out_l" input = "compressor:in_l"}
                    { output = "virtualbass:out_r" input = "compressor:in_r"}
                    { output = "compressor:out_l" input = "limiter:Input 1"}
                    { output = "compressor:out_r" input = "limiter:Input 2"}
                    
                    { output = "limiter:Output 1" input = "convLT:In"}
                    { output = "limiter:Output 1" input = "convLW:In"}
                    { output = "limiter:Output 2" input = "convRT:In"}
                    { output = "limiter:Output 2" input = "convRW:In"}
                    
                    { output = "convLW:Out" input = "LW:In"}
                    { output = "convRW:Out" input = "RW:In"}
                    { output = "convLW:Out" input = "LW2:In"}
                    { output = "convRW:Out" input = "RW2:In"}
                ]

                inputs = [ "virtualbass:in_l" "virtualbass:in_r" ]
                
                # changed the outputs order
                # following 16,1 2019 model at /System/Library/Audio/Tunings/Mac-E1008331FDC96864/DSP/Graphs/builtin_speaker_out.dspg
                # [def numChansOut 6] ; rdar://46105807; Mapping Ch 0 - Ch 5; Left woofer 1, left woofer 2, left tweeter, right woofer 1, right woofer 2, right tweeter as of 12/03/18
                outputs = [ 
                            "LW:Out"
                            "LW2:Out"
                            "convLT:Out"
                            "RW:Out"
                            "RW2:Out"
                            "convRT:Out"
                            ]
            }
            capture.props = {
                node.name = "effect_input.filter-chain-speakers"
                media.class = Audio/Sink
                audio.channels = 2
                audio.position = [ FL FR ]
            }

            playback.props = {
                node.name = "effect_output.filter-chain-speakers"
                node.target = "alsa_output.pci-0000_04_00.3.Speakers"
                node.passive = true
                node.hidden = true
                audio.channels = 6
                audio.position = [ "FL", "SL", "RL", "FR", "SR", "RR" ]
            }
        }
    }
]
